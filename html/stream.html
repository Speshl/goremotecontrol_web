<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.2" integrity="sha384-L6OqL9pRWyyFU3+/bjdSri+iIphTN/bvYyM37tICVyOJkWZLpP2vGn6VUEXgzg6h" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>

    <title>Go Remote Control</title>
    <style>
        video {
            width: 90%;
            height: auto;
        }
    </style>
</head>
<body>

    Video<br />
    <div id="remoteVideos" controls autoplay></div> <br />

    <!-- Audio<br />
    <audio id="audioElement" controls autoplay></audio> -->
    
    Logs<br />
    <div id="div"></div>

<script>
    const socket = io();

    const pc = new RTCPeerConnection({
        iceServers: [{
        urls: 'stun:stun.l.google.com:19302'
        }]
    })

    const log = msg => {
        document.getElementById('div').innerHTML += msg + '<br>'
    }

    pc.onicecandidateerror = e => {
        log("ICE Candidate Error: "+JSON.stringify(e))
        console.log("Connection State: "+JSON.stringify(e))
    }

    pc.onconnectionstatechange = e => {
        log("Connection State: "+pc.iceConnectionState)
        console.log("Connection State: "+pc.iceGatheringState)
    }

    pc.onicegatheringstatechange = e => {
        log("Ice Gathering State: "+pc.iceConnectionState)
        console.log("Ice Gathering State: "+pc.iceGatheringState)
    }

    pc.oniceconnectionstatechange = e => {
        log("Ice Connection State: "+pc.iceConnectionState)
        console.log("Ice Connection State: "+pc.iceConnectionState)
    }

    // pc.onnegotiationneeded = async () => {
    //     try {
    //         const offer = await pc.createOffer();
    //         await pc.setLocalDescription(offer);

    //         socket.emit('offer', btoa(JSON.stringify(pc.localDescription)));
    //     } catch (error) {
    //         console.error('Error creating offer:', error);
    //     }
    // };

    pc.onicecandidate = event => {
        if (event.candidate === null) {
            console.log("Emmiting offer");
            socket.emit('offer', btoa(JSON.stringify(pc.localDescription)));
        }else{
            console.log("Found Candidate");
            socket.emit('candidate', btoa(JSON.stringify(event.candidate)));
        }
    }

    pc.ontrack = (event) => {
        console.log("Track Added");
        log("Track Added");
        // const el = document.createElement(event.track.kind);
        // el.srcObject = event.streams[0];
        // el.autoplay = true;
        // el.controls = true;
        //document.getElementById('remoteVideos').appendChild(el);

        
        // const audioElement = document.getElementById('audioElement');
        // audioElement.srcObject = event.streams[0];

        const videoElement = document.getElementById('videoElement');
        audioElement.srcObject = event.streams[0];
    }

    //Offer to receive 1 audio, and 1 video track
    pc.addTransceiver('video', {
        direction: 'recvonly'
    })
    // pc.addTransceiver('audio', {
    //     direction: 'recvonly'
    // })

    pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log)

    socket.on('answer', (answer) => {
        let decodedAnswer = JSON.parse(atob(answer));
        log("Setting remote Description");
        console.log("Setting Remote Description");
        console.log(JSON.stringify(decodedAnswer));

        pc.setRemoteDescription(decodedAnswer)
            .then(() => {
                console.log("Set Remote Description");
                console.log(JSON.stringify(pc.remoteDescription));
                log("Set remote Description");
            })
            .catch((error) => {
                console.error("Error setting remote description:", error);
                alert("Error setting remote description: " + error.message);
            });
    });

    socket.on('candidate', async(candidate) => {
        try {
            setTimeout(async() => {
                const decodedCandidate = JSON.parse(atob(candidate));
                console.log(JSON.stringify(decodedCandidate))
                await pc.addIceCandidate(decodedCandidate);
                log('Added ICE candidate');
                console.log("Added ICE candidate");
            }, 1000);
        } catch (e) {
            alert(e);
        }
    });
    
</script>
</body>
</html>
