<!DOCTYPE html>
<html lang="en">
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://unpkg.com/htmx.org@1.9.2" integrity="sha384-L6OqL9pRWyyFU3+/bjdSri+iIphTN/bvYyM37tICVyOJkWZLpP2vGn6VUEXgzg6h" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
        <title>Go Remote Control</title>
    </head>
<body>
	<h1>No Controller Connected</h1>
</body>

<script type="text/javascript">

if (window["WebSocket"]) {
    var socket = io()

    // global gamepad object
    let gamepadIndex;
    window.addEventListener('gamepadconnected', (event) => {
        gamepadIndex = event.gamepad.index;
    });

    setInterval(() => {
        if(gamepadIndex !== undefined) {
            // a gamepad is connected and has an index
            const myGamepad = navigator.getGamepads()[gamepadIndex];
            document.body.innerHTML = ""; // reset page

            myGamepad.buttons.forEach((button, buttonIndex) => {
                if(button.pressed){
                    document.body.innerHTML += `<h1>Button ${buttonIndex} is pressed. Value: ${button.value}</h1>`;
                }
            })

            document.body.innerHTML += `<h1>Left Stick X: ${myGamepad.axes[0]} Y:${myGamepad.axes[1]}</h1>`;

            document.body.innerHTML += `<h1>Right Stick X: ${myGamepad.axes[2]} Y:${myGamepad.axes[3]}</h1>`;

            //esc value

            //xbox controller
            //button 6 is brake
            //button 7 is gas
            let command = [127,127]

            if(myGamepad.axes[0] > .1){
                command[0] = 255
            }else if(myGamepad.axes[0] < -.1){
                command[0] = 0
            }else{
                command[0] = 127
            }

            if(myGamepad.buttons[6].value > .1 &&  myGamepad.buttons[6].value > myGamepad.buttons[7].value){
                //brake
                command[1] = 0
            }else if(myGamepad.buttons[7].value > .1){
                command[1] = 255
            }else{
                command[1] = 127
            }
            
            socket.emit('command', command);
        }
    }, 10) // print buttons that are pressed 10 times per second
} else {
    var item = document.createElement("div");
    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
    appendLog(item);
}
</script>
</html>